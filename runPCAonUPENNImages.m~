% runPCAonUPENNImages
%
% Run principal component analysis on the texture statistics from both the 
% UPenn images, comparing natural scenes, taken in Botswana, and humanmade 
% scenes, taken in Philadelphia.
%

%% Clear
close all; clear;

%% Add path to texture analysis functions in separate directory from the TextureAnalysis repo
% Note: you will need to download this repo. See https://github.com/ttesileanu/TextureAnalysis
baseDir = fullfile('/Users', 'anniesu', 'Documents', 'MATLAB');

% You may need to edit this path to fit with your matlab file configuration
pathToTextureAnalysisFiles = fullfile(baseDir, 'projects', 'Analysis', 'TextureAnalysis');
addpath(pathToTextureAnalysisFiles);

% Add path to Annie's scripts. Note: add this into the GistFromTexture
% folder eventually. 
pathToAnnieScripts = fullfile(baseDir, 'purm_scripts');
addpath(pathToAnnieScripts);

%% Parameters
blockAF = 8;
patchSize = 32;

%% Process the image set directories
baseDir = fullfile(filesep,'/Volumes', 'Annie');
manmadeDirectory = fullfile(baseDir, 'manmade');
naturalDirectory = fullfile(baseDir, 'UPENNNaturalImageProject', 'BotswanaImagesCheck_061617', 'out', 'cd59A');

%% List file names in cell. Note we only want the JPG's
fileNamesManmade = direcNames(manmadeDirectory);
fileNamesNatural = direcNames(naturalDirectory);

% Parse for JPG files only. Delete cells that aren't JPG file names. 
for ii = 1:size(fileNamesManmade, 2)
    [pathstr, name, ext] = ...
        fileparts(fullfile(manmadeDirectory, fileNamesManmade{ii}));
    type = name(end - 2:end);
    if (~strcmp(ext, '.JPG') || strcmp(fileNamesManmade{ii}(1:2), '._'))
        fileNamesManmade{ii} = [];
    end
end
fileNamesManmade(cellfun(@(fileNamesManmade) isempty(fileNamesManmade), fileNamesManmade)) = [];

for ii = 1:size(fileNamesNatural, 2)
    [pathstr, name, ext] = ...
        fileparts(fullfile(naturalDirectory, fileNamesNatural{ii}));
    type = name(end - 2:end);
    if (~strcmp(ext, '.JPG') || strcmp(fileNamesNatural{ii}(1:2), '._'))
        fileNamesNatural{ii} = [];
    end
end
fileNamesManmade(cellfun(@(fileNamesManmade) isempty(fileNamesManmade), fileNamesManmade)) = [];
fileNamesNatural(cellfun(@(fileNamesNatural) isempty(fileNamesNatural), fileNamesNatural)) = [];

%% Calculate the texture statistics
manmadeResults = plotCommands(fileNamesManmade, manmadeDirectory, blockAF, patchSize);
naturalResults = plotCommands(fileNamesNatural, naturalDirectory, blockAF, patchSize);

% Compile manmade and natural scene statistics
allResults = [manmadeResults.ev; naturalResults.ev];

%% Run PCA on the texture statistics
% blue: manmade scenes, orange: natural scenes

% Mean-center the results, find singular value decomposition.
mu = mean(allResults, 1);
allResultsCentered = bsxfun(@minus, allResults, mu);
[svdU, svdS, svdV] = svd(allResultsCentered, 0);

% Project the data onto the principal components 
allResultsProj = allResultsCentered * svdV;

% Plot the first two PC's, with the blue color for manmade scenes and 
% orange for natural
colors = zeros(size(allResultsProj, 1));
colors(1:size(manmadeResults.ev, 1)) = [0 1 1];
colors(size(manmadeResults.ev, 1) + 1:end) = [0 1 0];

colorsForManmade = repmat([0 1 1];
for ii = 1:size(colors, 1)
    if (ii <= size(manmadeResults.ev, 1))
        % cyan
        colors(ii, 1) = 0;
        colors(ii, 2) = 1;
        colors(ii, 3) = 1;
    else 
        % green
        colors(ii, 1) = 0;
        colors(ii, 2) = 1;
        colors(ii, 3) = 0;
    end
end

scatter(allResultsProj(:, 1), allResultsProj(:, 2), [], colors);


pcaData.mu = mu;
pcaData.U = svdU;
pcaData.S = svdS;
pcaData.V = svdV;


%% Bad/incorrect plotting
ax1 = subplot(1, 2, 1); runPca(manmadeResults); title('manmade scenes');
ax2 = subplot(1, 2, 2); runPca(naturalResults); title('natural scenes');
linkaxes([ax1, ax2], 'xy');


% fuck fuck fuck fuck fuck fuck fuck. plot in two colors. 

